<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Vitals - ç›‘æ§é¢æ¿</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 0;
        margin-bottom: 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
      }

      .online {
        color: #10b981;
      }
      .offline {
        color: #ef4444;
      }
      .unknown {
        color: #f59e0b;
      }

      .services-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
      }

      tr:hover {
        background-color: #f9fafb;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
      }

      .status-online {
        background-color: #d1fae5;
        color: #065f46;
      }

      .status-offline {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .status-unknown {
        background-color: #fef3c7;
        color: #92400e;
      }

      .url-link {
        color: #3b82f6;
        text-decoration: none;
      }

      .url-link:hover {
        text-decoration: underline;
      }

      .history {
        margin-top: 10px;
        padding: 10px;
        background-color: #f8fafc;
        border-radius: 5px;
        font-size: 0.8rem;
      }

      .history-item {
        margin-bottom: 5px;
        color: #6b7280;
      }

      .auto-refresh {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #3b82f6;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .loading-indicator {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff40;
        border-top: 2px solid #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background-color: #fee2e2;
        color: #991b1b;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
      }

      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .header h1 {
          font-size: 2rem;
        }

        table {
          font-size: 0.9rem;
        }

        th,
        td {
          padding: 10px 8px;
        }

        .stats {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="auto-refresh">
      ğŸ”„ è‡ªåŠ¨åˆ·æ–°: æ¯3ç§’æ›´æ–°
      <div class="loading-indicator"></div>
    </div>

    <div class="container">
      <div class="error-message" id="error-message"></div>

      <div class="header">
        <h1>Service Vitals</h1>
        <p id="last-updated">å®æ—¶æœåŠ¡ç›‘æ§é¢æ¿ - æœ€åæ›´æ–°: {{ last_updated }}</p>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-services">
            {{ services.len() }}
          </div>
          <div class="stat-label">æ€»æœåŠ¡æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-number online" id="online-services">
            {{ online_count }}
          </div>
          <div class="stat-label">åœ¨çº¿æœåŠ¡</div>
        </div>
        <div class="stat-card">
          <div class="stat-number offline" id="offline-services">
            {{ offline_count }}
          </div>
          <div class="stat-label">ç¦»çº¿æœåŠ¡</div>
        </div>
        <div class="stat-card">
          <div class="stat-number unknown" id="unknown-services">
            {{ unknown_count }}
          </div>
          <div class="stat-label">æœªçŸ¥çŠ¶æ€</div>
        </div>
      </div>

      <div class="services-table">
        <table>
          <thead>
            <tr>
              <th>æœåŠ¡åç§°</th>
              <th>æœåŠ¡URL</th>
              <th>çŠ¶æ€</th>
              <th>å“åº”å»¶è¿Ÿ</th>
              <th>æœ€åæ£€æŸ¥</th>
            </tr>
          </thead>
          <tbody id="services-tbody">
            {% for service in services %}
            <tr>
              <td>
                <strong>{{ service.name }}</strong>
                {% if !service.history.is_empty() %}
                <div class="history">
                  <strong>çŠ¶æ€å†å²:</strong>
                  {% for history in service.history %}
                  <div class="history-item">
                    {{ history.timestamp.format("%H:%M:%S") }} - {{
                    history.status }} {% match history.response_time_ms %} {%
                    when Some with (rt) %} ({{ rt }}ms) {% when None %} {%
                    endmatch %}
                  </div>
                  {% endfor %}
                </div>
                {% endif %}
              </td>
              <td>
                {% if !service.url.is_empty() %}
                <a href="{{ service.url }}" target="_blank" class="url-link"
                  >{{ service.url }}</a
                >
                {% else %} - {% endif %}
              </td>
              <td>
                <span class="status-badge status-{{ service.status|lower }}">
                  {{ service.status }}
                </span>
              </td>
              <td>
                {% match service.response_time_ms %} {% when Some with (rt) %}
                {{ rt }}ms {% when None %} - {% endmatch %}
              </td>
              <td>
                {% match service.last_check %} {% when Some with (last_check) %}
                {{ last_check.format("%Y-%m-%d %H:%M:%S") }} {% when None %} -
                {% endmatch %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <script>
        let isLoading = false;
        let errorCount = 0;
        const maxErrors = 5;

        // æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function showLoading(show) {
            const indicator = document.querySelector('.loading-indicator');
            indicator.style.display = show ? 'block' : 'none';
            isLoading = show;
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(data) {
            document.getElementById('total-services').textContent = data.total_services;
            document.getElementById('online-services').textContent = data.online_services;
            document.getElementById('offline-services').textContent = data.offline_services;
            document.getElementById('unknown-services').textContent = data.total_services - data.online_services - data.offline_services;
            document.getElementById('last-updated').textContent = `å®æ—¶æœåŠ¡ç›‘æ§é¢æ¿ - æœ€åæ›´æ–°: ${formatDateTime(data.last_updated)}`;
        }

        // æ›´æ–°æœåŠ¡è¡¨æ ¼
        function updateServicesTable(services) {
            const tbody = document.getElementById('services-tbody');
            tbody.innerHTML = '';

            services.forEach(service => {
                const row = document.createElement('tr');
                row.className = 'fade-in';

                // æ„å»ºå†å²è®°å½•HTML
                let historyHtml = '';
                if (service.history && service.history.length > 0) {
                    historyHtml = `
                        <div class="history">
                            <strong>çŠ¶æ€å†å²:</strong>
                            ${service.history.map(h => `
                                <div class="history-item">
                                    ${formatDateTime(h.timestamp)} - ${h.status}
                                    ${h.response_time_ms ? `(${h.response_time_ms}ms)` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                row.innerHTML = `
                    <td>
                        <strong>${service.name}</strong>
                        ${historyHtml}
                    </td>
                    <td>
                        ${service.url ? `<a href="${service.url}" target="_blank" class="url-link">${service.url}</a>` : '-'}
                    </td>
                    <td>
                        <span class="status-badge status-${service.status.toLowerCase()}">
                            ${service.status}
                        </span>
                    </td>
                    <td>
                        ${service.response_time_ms ? `${service.response_time_ms}ms` : '-'}
                    </td>
                    <td>
                        ${service.last_check ? formatDateTime(service.last_check) : '-'}
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // è·å–æœ€æ–°æ•°æ®
        async function fetchData() {
            if (isLoading) return;

            try {
                showLoading(true);
                const response = await fetch('/api/v1/status');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // æ›´æ–°é¡µé¢å†…å®¹
                updateStats(data);
                updateServicesTable(data.services);

                // é‡ç½®é”™è¯¯è®¡æ•°
                errorCount = 0;

            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                errorCount++;

                if (errorCount <= maxErrors) {
                    showError(`è·å–æ•°æ®å¤±è´¥: ${error.message} (${errorCount}/${maxErrors})`);
                } else {
                    showError('è¿ç»­è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢');
                }
            } finally {
                showLoading(false);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹å®šæ—¶æ›´æ–°
        document.addEventListener('DOMContentLoaded', function() {
            // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
            fetchData();

            // æ¯3ç§’æ›´æ–°ä¸€æ¬¡
            setInterval(fetchData, 3000);
        });
  </body>
</html>
